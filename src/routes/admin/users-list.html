<header class="fade-in-heading">
  <h1 class="text-xl font-bold text-white md:text-2xl">Manage Users</h1>
  <p class="mt-2 text-sm text-neutral-400 md:text-base">View and manage user accounts.</p>
</header>

<div class="fade-in animation-delay-2 mt-6 mb-6">
  <%~ include('../_components/flash-message.html') %>
</div>

<div class="fade-in animation-delay-3 mb-6 max-w-2xl">
  <form action="/admin/users" method="get" class="flex gap-2">
    <%~ include('../_components/inputs/search.html', { name: 'search', placeholder: 'Search by name or email', value: it.search }) %>
    <%~ include('../_components/button.html', { text: 'Search', minWidth: true }) %>
  </form>
</div>

<div class="fade-in animation-delay-4 overflow-x-auto rounded-lg border border-neutral-800 bg-neutral-900">
  <table class="w-full text-left">
    <thead class="border-b border-neutral-800 text-neutral-400">
      <tr>
        <th class="p-4">ID</th>
        <th class="p-4">User</th>
        <th class="p-4">API Calls</th>
        <th class="p-4">Limit</th>
        <th class="p-4">Created</th>
        <th class="p-4">Updated</th>
        <th class="p-4"></th>
      </tr>
    </thead>
    <tbody class="divide-y divide-neutral-800">
      <% for (const user of it.users) { %>
      <tr class="hover:bg-neutral-800/50">
        <td class="p-4 text-neutral-400"><%= user.id %></td>
        <td class="p-4">
          <div class="flex items-center gap-2">
            <a href="/admin/users/<%= user.id %>" class="text-white hover:text-power"><%= user.name %></a>
            <% if (user.verified) { %>
            <%~ include('../_components/badge.html', { text: 'Verified', variant: 'success' }) %>
            <% } else { %>
            <%~ include('../_components/badge.html', { text: 'Unverified', variant: 'warning' }) %>
            <% } %>
          </div>
          <a href="mailto:<%= user.email %>" class="text-sm text-neutral-400 hover:text-white"><%= user.email %></a>
        </td>
        <td class="p-4 text-neutral-300"><%= user.api_call_count %></td>
        <td class="p-4 text-neutral-300"><%= user.api_call_limit %></td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(user.created_at).toLocaleString() %></td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(user.updated_at).toLocaleString() %></td>
        <td class="p-4">
          <%~ include('../_components/actions-dropdown.html', {
            id: 'dropdown-user-' + user.id,
            items: [
              { label: 'Update API Limit', modal: 'modal-limit-' + user.id },
              { label: 'Resend Verification', modal: 'modal-resend-' + user.id, disabled: user.verified }
            ]
          }) %>
        </td>
      </tr>
      <% } %>
      <% if (it.users.length === 0) { %>
      <tr>
        <td colspan="7" class="p-8 text-center text-neutral-400">No users found.</td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<% for (const user of it.users) { %>
<% const escapedName = user.name.split('&').join('&amp;').split(String.fromCharCode(60)).join('&lt;').split(String.fromCharCode(62)).join('&gt;').split('"').join('&quot;'); %>
<%~ include('../_components/modal.html', {
  id: 'modal-limit-' + user.id,
  action: '/admin/users/' + user.id + '/api-limit',
  title: 'Update API Limit',
  description: 'Set a new API call limit for <span class="text-white">' + escapedName + '</span>.',
  input: include('../_components/inputs/number.html', { label: 'API Call Limit', name: 'api_call_limit', value: user.api_call_limit, min: 0, required: true }),
  confirmText: 'Update Limit'
}) %>
<% if (!user.verified) { %>
<%~ include('../_components/modal.html', {
  id: 'modal-resend-' + user.id,
  action: '/admin/users/' + user.id + '/resend-verification',
  title: 'Resend Verification Email',
  description: 'Send a new verification email to <span class="text-white">' + escapedName + '</span>.',
  confirmText: 'Send Email'
}) %>
<% } %>
<% } %>

<% if (it.pagination.pages > 1) { %>
<div class="fade-in animation-delay-5 mt-6 flex items-center justify-center gap-2">
  <% if (it.pagination.current_page > 1) { %>
  <a href="/admin/users?page=<%= it.pagination.current_page - 1 %>&search=<%= encodeURIComponent(it.search) %>" class="rounded-md bg-neutral-800 px-3 py-2 text-neutral-300 hover:bg-neutral-700">Previous</a>
  <% } %>
  <span class="px-4 text-neutral-400">
    Page <%= it.pagination.current_page %> of <%= it.pagination.pages %>
  </span>
  <% if (it.pagination.current_page < it.pagination.pages) { %>
  <a href="/admin/users?page=<%= it.pagination.current_page + 1 %>&search=<%= encodeURIComponent(it.search) %>" class="rounded-md bg-neutral-800 px-3 py-2 text-neutral-300 hover:bg-neutral-700">Next</a>
  <% } %>
</div>
<% } %>

<script>
document.querySelectorAll('.open-modal').forEach(function(button) {
  button.addEventListener('click', function() {
    document.getElementById(button.dataset.modal).showModal();
  });
});
</script>
