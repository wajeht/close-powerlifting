<header class="fade-in-heading">
  <h1 class="text-2xl font-bold text-white">Cache Management</h1>
  <p class="mt-2 text-neutral-400">View and manage cached data.</p>
</header>

<div class="fade-in animation-delay-2 mt-6 mb-6">
  <%~ include('../_components/flash-message.html') %>
</div>

<!-- Search and Actions -->
<div class="fade-in animation-delay-3 mb-6 flex flex-wrap items-center gap-4">
  <form action="/admin/cache" method="get" class="flex flex-1 gap-2">
    <%~ include('../_components/inputs/search.html', { name: 'search', placeholder: 'Search by key...', value: it.search }) %>
    <%~ include('../_components/button.html', { text: 'Search', minWidth: true }) %>
  </form>
  <button type="button" class="open-modal rounded-md bg-red-600 px-4 py-2 font-medium text-white transition-all hover:bg-red-700 sm:min-w-52" data-modal="clear-all-modal">Clear All Cache</button>
</div>

<!-- Cache Entries -->
<div class="fade-in animation-delay-5 overflow-x-auto rounded-lg border border-neutral-800 bg-neutral-900">
  <table class="w-full text-left">
    <thead class="border-b border-neutral-800 text-neutral-400">
      <tr>
        <th class="p-4">Key</th>
        <th class="p-4">Value Preview</th>
        <th class="p-4">Created</th>
        <th class="p-4">Updated</th>
        <th class="p-4"></th>
      </tr>
    </thead>
    <tbody class="divide-y divide-neutral-800">
      <% for (const entry of it.entries) { %>
      <tr class="hover:bg-neutral-800/50">
        <td class="p-4 font-mono text-sm text-white"><%= entry.key %></td>
        <td class="max-w-xs truncate p-4 text-sm text-neutral-400" title="<%= entry.value.substring(0, 200) %>">
          <%= entry.value.substring(0, 100) %><%= entry.value.length > 100 ? '...' : '' %>
        </td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(entry.created_at).toLocaleString() %></td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(entry.updated_at).toLocaleString() %></td>
        <td class="p-4">
          <%~ include('../_components/actions-dropdown.html', {
            id: 'dropdown-cache-' + entry.key.replace(/[^a-zA-Z0-9]/g, '-'),
            items: [
              { label: 'Delete', modal: 'delete-modal-' + entry.key.replace(/[^a-zA-Z0-9]/g, '-'), variant: 'danger' }
            ]
          }) %>
        </td>
      </tr>
      <% } %>
      <% if (it.entries.length === 0) { %>
      <tr>
        <td colspan="5" class="p-8 text-center text-neutral-400">No cache entries found.</td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<% if (it.pagination.pages > 1) { %>
<div class="fade-in animation-delay-6 mt-6 flex items-center justify-center gap-2">
  <% if (it.pagination.current_page > 1) { %>
  <a href="/admin/cache?page=<%= it.pagination.current_page - 1 %>&search=<%= encodeURIComponent(it.search) %>" class="rounded-md bg-neutral-800 px-3 py-2 text-neutral-300 hover:bg-neutral-700">Previous</a>
  <% } %>
  <span class="px-4 text-neutral-400">
    Page <%= it.pagination.current_page %> of <%= it.pagination.pages %>
  </span>
  <% if (it.pagination.current_page < it.pagination.pages) { %>
  <a href="/admin/cache?page=<%= it.pagination.current_page + 1 %>&search=<%= encodeURIComponent(it.search) %>" class="rounded-md bg-neutral-800 px-3 py-2 text-neutral-300 hover:bg-neutral-700">Next</a>
  <% } %>
</div>
<% } %>

<%~ include('../_components/modal.html', {
  id: 'clear-all-modal',
  action: '/admin/cache/clear',
  title: 'Clear All Cache',
  description: 'Are you sure you want to clear all cache entries? This action cannot be undone.',
  confirmText: 'Clear All',
  confirmVariant: 'danger'
}) %>

<% for (const entry of it.entries) { %>
<% const escapedKey = entry.key.split('&').join('&amp;').split(String.fromCharCode(60)).join('&lt;').split(String.fromCharCode(62)).join('&gt;').split('"').join('&quot;'); %>
<%~ include('../_components/modal.html', {
  id: 'delete-modal-' + entry.key.replace(/[^a-zA-Z0-9]/g, '-'),
  action: '/admin/cache/delete',
  title: 'Delete Cache Entry',
  description: 'Delete cache entry <code class="rounded bg-neutral-800 px-1 text-white">' + escapedKey + '</code>?',
  hiddenName: 'key',
  hiddenValue: entry.key,
  confirmText: 'Delete',
  confirmVariant: 'danger'
}) %>
<% } %>

<script>
document.querySelectorAll('.open-modal').forEach(function(button) {
  button.addEventListener('click', function() {
    document.getElementById(button.dataset.modal).showModal();
  });
});
</script>
