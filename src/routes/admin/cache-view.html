<header class="fade-in-heading">
  <h1 class="text-2xl font-bold text-white">Cache Management</h1>
  <p class="mt-2 text-neutral-400">View and manage cached data.</p>
</header>

<div class="fade-in animation-delay-2 mt-6 mb-6">
  <%~ include('../_components/flash-message.html') %>
</div>

<!-- Search and Actions -->
<div class="fade-in animation-delay-3 mb-6 flex flex-wrap items-center gap-4">
  <form action="/admin/cache" method="get" class="flex flex-1 gap-2">
    <%~ include('../_components/inputs/search.html', { name: 'search', placeholder: 'Search by key...', value: it.search }) %>
    <%~ include('../_components/button.html', { text: 'Search' }) %>
  </form>
  <button type="button" class="open-modal rounded-md bg-red-600 px-4 py-2 font-medium text-white transition-all hover:bg-red-700" data-modal="clear-all-modal">Clear All Cache</button>
</div>

<!-- Cache Entries -->
<div class="fade-in animation-delay-5 overflow-x-auto rounded-lg border border-neutral-800 bg-neutral-900">
  <table class="w-full text-left">
    <thead class="border-b border-neutral-800 text-neutral-400">
      <tr>
        <th class="p-4">Key</th>
        <th class="p-4">Created</th>
        <th class="p-4">Updated</th>
        <th class="p-4">Value Preview</th>
        <th class="p-4"></th>
      </tr>
    </thead>
    <tbody class="divide-y divide-neutral-800">
      <% for (const entry of it.entries) { %>
      <tr class="hover:bg-neutral-800/50">
        <td class="p-4 font-mono text-sm text-white"><%= entry.key %></td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(entry.created_at).toLocaleString() %></td>
        <td class="p-4 text-sm text-neutral-300"><%= new Date(entry.updated_at).toLocaleString() %></td>
        <td class="max-w-xs truncate p-4 text-sm text-neutral-400" title="<%= entry.value.substring(0, 200) %>">
          <%= entry.value.substring(0, 100) %><%= entry.value.length > 100 ? '...' : '' %>
        </td>
        <td class="p-4">
          <button
            type="button"
            class="open-modal rounded p-1 text-neutral-400 hover:bg-neutral-800 hover:text-red-400"
            data-modal="delete-modal-<%= entry.key.replace(/[^a-zA-Z0-9]/g, '-') %>"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </td>
      </tr>
      <% } %>
      <% if (it.entries.length === 0) { %>
      <tr>
        <td colspan="5" class="p-8 text-center text-neutral-400">No cache entries found.</td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- Clear All Confirmation Modal -->
<dialog id="clear-all-modal" class="fixed inset-0 m-auto h-fit rounded-lg border border-neutral-800 bg-neutral-900 p-6 backdrop:bg-black/70">
  <form action="/admin/cache/clear" method="post" class="flex flex-col gap-4 w-80">
    <%~ include('../_components/csrf-input.html') %>
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-white">Clear All Cache</h3>
      <button type="submit" formmethod="dialog" class="rounded p-1 text-neutral-400 hover:bg-neutral-800 hover:text-white">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p class="text-sm text-neutral-400">Are you sure you want to clear all cache entries? This action cannot be undone.</p>
    <div class="flex gap-2 justify-end">
      <%~ include('../_components/button.html', { text: 'Cancel', variant: 'secondary', formmethod: 'dialog', autofocus: true }) %>
      <%~ include('../_components/button.html', { text: 'Clear All', variant: 'danger' }) %>
    </div>
  </form>
</dialog>

<!-- Delete Entry Confirmation Modals -->
<% for (const entry of it.entries) { %>
<dialog id="delete-modal-<%= entry.key.replace(/[^a-zA-Z0-9]/g, '-') %>" class="fixed inset-0 m-auto h-fit rounded-lg border border-neutral-800 bg-neutral-900 p-6 backdrop:bg-black/70">
  <form action="/admin/cache/delete" method="post" class="flex flex-col gap-4 w-80">
    <%~ include('../_components/csrf-input.html') %>
    <input type="hidden" name="key" value="<%= entry.key %>" />
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-white">Delete Cache Entry</h3>
      <button type="submit" formmethod="dialog" class="rounded p-1 text-neutral-400 hover:bg-neutral-800 hover:text-white">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p class="text-sm text-neutral-400">Delete cache entry <code class="rounded bg-neutral-800 px-1 text-white"><%= entry.key %></code>?</p>
    <div class="flex gap-2 justify-end">
      <%~ include('../_components/button.html', { text: 'Cancel', variant: 'secondary', formmethod: 'dialog', autofocus: true }) %>
      <%~ include('../_components/button.html', { text: 'Delete', variant: 'danger' }) %>
    </div>
  </form>
</dialog>
<% } %>

<script>
document.querySelectorAll('.open-modal').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.getElementById(btn.dataset.modal).showModal();
  });
});
</script>
